---
title: "Covid19_prediction"
author: "Laura Cavenati, Lori, Marco Distrutti, Santosh"
date: "06 maggio 2020"
output:
  html_document:
    df_print: paged
---

Ultimamente si sente dire spesso che il numero di decessi dovuti al covid in Italia sia molto superiore ai dati forniti giornalmente dalla protezione civile.
Proviamo quindi a dare una stima ragionevole dei morti COVID a partire dal numero dei decessi avvenuti in Italia fino al 31 Marzo 2020 secondo l'Istat.
Purtroppo i dati Istat non costituiscono un campione rappresentativo dell’universo dei comuni italiani, ma solo un loro sottoinsieme meritevole di attenzione. L’Istat ha scelto infatti di concentrare l’attenzione sui comuni presenti in ANPR (Anagrafe Nazionale Popolazione Residente), con dati affidabili, che presentano almeno dieci decessi nel periodo 4 gennaio - 4 aprile 2020 e che hanno registrato un aumento dei morti pari o superiore al 20 per cento nel periodo 1 marzo-4 aprile 2020 rispetto al dato medio dello stesso periodo degli anni 2015-2019.
Per un'analisi più dettagliata delle caratteristiche dei comuni considerati, si rimanda al sito:
https://www.istat.it/it/archivio/240401

Ci concentriamo sul periodo gennaio-marzo perchè i dati relativi ad aprile non sono ancora affidaibi e completi.

Si noti inoltre che più che calcolare i morti COVID, faremo una stima dei decessi relazionati al covid. A causa delle restrizioni del governo e della quarantena, il numero di morti per incidenti stradali e sul lavoro è diminuito, il sistema sanitario essendo stato sotto forte stress ha causato difficoltà ad accedere al servizio a pazienti non COVID e sono aumentate le morti domestiche.
```{r message=FALSE, results='hide', error=FALSE}
library(dplyr)   
library(tidyr)   
library(ggplot2) 
library(plotly) 

setwd("C:\\Users\\Laura\\Desktop\\Covid19_prediction\\data")
pop<-read.csv("Popolazione_comuni_italiani.csv")
td<-read.csv("comune_giorno.csv")
ANPR<-read.csv("Tabella_45 Comuni subentrati.csv",sep=";")
tda<-read.csv("comuni_giornaliero.csv")
```
organizziamo, puliamo e sistemiamo i diversi dataset in modo che i dati siano ben organizzati per rispondere alla nostra domanda.
```{r, messagee=FALSE, results='hide', error=FALSE, warning=FALSE, warning=FALSE}
#sistemo il dataset in modo che i dati siano ben organizzati
pop %>% rename( COD_PROVCOM = ï..ITTER107, ABITANTI = Value )%>%
        filter(Sesso=="totale")%>%
        select(-c(Territorio:Seleziona.periodo ,Flag.Codes,Flags))%>%
        mutate(COD_PROVCOM=as.character(COD_PROVCOM))%>%
        mutate(COD_PROVCOM=as.numeric(COD_PROVCOM))->pop

pop <- na.omit(pop)
#ci sono alcune righe che non rappresentano comuni ma regioni e aree geografiche, quindi le tolgo. 

#Sistemo il dataframe in modo che sia più funzionale, come abbiamo fatto a lezione
td %>% gather(key="SESSO_ANNO", value="DECESSI", MASCHI_15:TOTALE_20)%>% 
      separate(SESSO_ANNO, c("SESSO", "ANNO"), "_")%>%
      mutate(DATA = as.Date(paste0("0", GE, "2020"), format = "%m%d%Y")) -> td

#Faccio una join con pop così aggiungo la colonna con il numero di abitanti per comune
td<-left_join(td, pop, by="COD_PROVCOM")

#Escono dei NAN che sono dovuti al fatto che i due diversi dataframe sono aggiornati a date diverse; 
#pop è aggornato al 01/01/2019, td al 04/04/2020. In questo lasso di 
#tempo alcuni comuni si sono fusi tra di loro, ne sono nati altri.
td <- na.omit(td)

td %>% select(-c(NOME_PROVINCIA,REG, PROV, CL_ETA,GE))%>%
      filter(SESSO=="TOTALE", DECESSI<9999, format(as.Date(DATA), "%m")!="04" )%>%
      group_by(ANNO, NOME_REGIONE, NOME_COMUNE, COD_PROVCOM, DATA_INIZIO_DIFF, ABITANTI, DATA)%>%
      summarise(DECESSI=sum(DECESSI))->tdp
```
INSERISCI GRAFICO LEZIONE 5


Per avere un'idea della bontà della copertura dei dati Istat, andiamo a vedere la percentuale di popolazione, relativa alle diverse regioni, di cui l'Istat ci ha fornito i dati e la percentuale di popolazione che rientra nei comuni considerati dall'ANPR.
Il file che riporta i comuni subentrati in ANPR che abbiamo utilizzato è disponibile a questo link: https://www.anpr.interno.it/portale/tabelle-di-riferimento
```{r,warning=FALSE}
ANPR %>% mutate(DATASUBENTRO=as.character(ANPR$DATASUBENTRO))%>%
        mutate(DATASUBENTRO=as.Date.character(ANPR$DATASUBENTRO,"%d/%m/%Y"))%>%
        mutate(diffDate=as.numeric(as.Date("2020-04-17")-ANPR$DATASUBENTRO))->ANPR

#considero solo i comuni che fanno parte dei comuni in ANPR in data 16/04/2020
ANPR %>% select(CODISTAT, DATASUBENTRO, diffDate)%>%
        filter(diffDate>0)%>%
        select(-c(diffDate,DATASUBENTRO))%>%
        rename(COD_PROVCOM=CODISTAT)->ANPR

#dataframe con abitanti per comune, COD_PROVCOM e relativa regione di appartenenza
td %>% distinct(NOME_REGIONE,COD_PROVCOM, ABITANTI)%>%
      group_by(COD_PROVCOM, ABITANTI)->AbitantiPerComune

left_join(ANPR, AbitantiPerComune, by="COD_PROVCOM")->ANPR

#Non ho la regione di tutti i comuni perchè i dataframe non sono aggiornati alla stessa data. Considero quindi questi comuni come se non rientrassero in ANPR
ANPR <- na.omit(ANPR)

#popolazione per regione coperta dall'ANPR
ANPR %>% group_by(NOME_REGIONE)%>%
        summarise(abitantiANPR=sum(ABITANTI))->ANPR

#abitanti per regione che rientrano nei comuni in ANPR
td %>% distinct(NOME_REGIONE, COD_PROVCOM, ABITANTI)%>%
      group_by(NOME_REGIONE)%>%
      summarise(abitanti=sum(ABITANTI))->AbitantiPerRegione

inner_join(AbitantiPerRegione, ANPR, by="NOME_REGIONE")->ANPR

#abitanti per regione che rientrano nei comuni considerati dall'Istat
td %>% filter(DATA_INIZIO_DIFF!="Dati 2020 n.d." )%>%
      distinct(NOME_COMUNE, NOME_REGIONE, ABITANTI)%>%
      group_by(NOME_REGIONE)%>%
      summarise(abitantiCampionati=sum(ABITANTI))->AbitantiPerRegioneCampionati

inner_join( ANPR, AbitantiPerRegioneCampionati, by="NOME_REGIONE")->TOT

#dataframe riassuntivo che compara le varie percentuali per regione
TOT %>% mutate(percANPR=abitantiANPR/abitanti*100,percCAMPIONATI=abitantiCampionati/abitanti*100)->TOT
TOT
```
I comuni monitorati dall’Istat sono un sottoinsieme di quelli che hanno aderito all’ANPR, la cui copertura, in termini di popolazione, è mostrata nella tabella.  
percANPR indica la percentuale della popoplazione, per regione, che rientra nei comuni in ANPR, percCAMPIONATI indica la percentuale della popoplazione, per regione, che rientra nei comuni campionati dall'Istat.
Come si vede, la copertura dei dati dell’Istat è tale da non permettere stime significative in molte regioni italiane (soprattutto quelle del sud, come Campania e Basilicata dove ci sono stati meno decessi dovuti al virus).

Scegliamo quindi di considerare solo la Lombardia, il cui campionamento messo a disposizione dall'Istat costituisce una buona copertura del totale.
La domanda finale a cui vogliamo risolvere è quindi: "QUANTI SONO STATI I DECESSI RELAZIONATI A COVID IN LOMARDIA NEL PERIODO DAL 1 GENNAIO AL 31 MARZO 2020?"
  
```{r message=FALSE, results='hide', error=FALSE}
tdp %>% filter(NOME_REGIONE=="Lombardia")->tdpl
TOT %>%  filter(NOME_REGIONE=="Lombardia")->Lombardia
```
Per trovare i morti dovuti al covid non consideriamo come base la media stagionale dei morti negli anni 15-19 perchè, come si vede dal grafico, nel periodo gennaio-febbraio 2020, ci sono state meno morti rispetto agli anni precedenti. Ciò potrebbe essere dovuto al fatto che l’inverno 2019-2020 è stato tra i più caldi degli ultimi 100 anni.
Le statistiche dell'Istituto di scienze dell'atmosfera e del clima del Cnr di Bologna infatti affermano che l'inverno appena trascorso, ha fatto registrare in Italia un'anomalia di 2,03°C al di sopra della media stagionale relativa al trentennio 1981-2010. 
Assumiamo quindi che il numero di morti per il 2020, escludendo i decessi causati dal covid, sia pari a quello del 2016 che, come notiamo dal grafico, ha avuto un andamento simile. Per trovare il numero di morti covid quindi sottraiamo ai morti del 2020 quelli del 2016 nei mesi considerati.

```{r message=FALSE, results='hide', error=FALSE}
tdpl %>% filter(DATA_INIZIO_DIFF!="Dati 2020 n.d.")%>%
        group_by(ANNO)%>%
        summarise(DECESSIperanno=sum(DECESSI))->tdplc


tdp%>%  filter(DATA_INIZIO_DIFF!="Dati 2020 n.d.",format(as.Date(DATA), "%m")!="03",as.Date(DATA)!=as.Date("2020-02-29"))%>%
        group_by(DATA, ANNO) %>%
        summarise(DECESSI = sum(DECESSI))%>% 
        arrange(ANNO, DATA) %>%                         
        ungroup()->tdpg 

tdpg %>% ggplot(aes(x = DATA, y = DECESSI, color = ANNO)) + geom_line()
```  
Per fare una stima dei morti covid, dato che non abbiamo tutti i comuni ma solo un campione non casuale, possiamo calcolare i morti covid con 'precisione' per i comuni di cui abbiamo i dati dall'Istat. Per i comuni non considerati dall'Istat ma che rientrano nei comuni in ANPR, possiamo fare delle stime, considerando come limite inferiore che non ci siano stati morti covid, e come limite superiore che la mortalità per covid sia stata pari a quella dei comuni campionati. Ipotizziamo inoltre che il fatto di rientrare o meno tra i comuni in ANPR sia scorrelata dal numero dei decessi in eccesso; considiamo quindi che i comuni ANPR abbiano avuto una mortalità per covid pari a quella media dei comuni analizzati dall'Istat.
```{r message=FALSE, results='hide', error=FALSE}
#morti per covid nei comuni campionati dall'Istat
mortiLombardiaCampionata<-tdplc$DECESSIperanno[6]-tdplc$DECESSIperanno[2]

#limite superiore dei morti per covid nei comuni non campionati dall'Istat
mortiLombardiaNonCampionatasup<-mortiLombardiaCampionata/Lombardia$abitantiCampionati*(Lombardia$abitantiANPR-Lombardia$abitantiCampionati)

#limite superiore e inferiore dei morti per covid nei comuni non in ANPR (pari a popolazione non in ANPR * mortalità covid nei comuni campionati dall'Istat)
mortiLombardiaNonANPRinf<-(Lombardia$abitanti-Lombardia$abitantiANPR)*((mortiLombardiaCampionata)/Lombardia$abitantiANPR)
mortiLombardiaNonANPRsup<-(Lombardia$abitanti-Lombardia$abitantiANPR)*((mortiLombardiaCampionata+mortiLombardiaNonCampionatasup)/Lombardia$abitantiANPR)

#limite superiore e inferiore dei morti totali covid
mortiCOVIDinf<-mortiLombardiaCampionata+mortiLombardiaNonANPRinf
mortiCOVIDsup<-mortiLombardiaCampionata+mortiLombardiaNonCampionatasup+mortiLombardiaNonANPRsup
```
Intervallo di confidenza per i morti covid in Lombardia fino a fine marzo:
```{r}
print(c(mortiCOVIDinf, mortiCOVIDsup))
```
Quesa forchetta di valori indica i decessi relazionati a covid in Lombardia nel periodo 1 gennaio-31 marzo 2020.


In realtà in data 4 maggio 2020 Istat ha fornito dei dati aggiornati per 6.866 comuni nel periodo 1 gennaio-31 marzo. Se ripetiamo le stesse analisi fatte precedentemente, possiamo arrivare a una stima dei decessi più precisa. (Per chiarezza non riportiamo tutto il codice ma solo l'output finale).

```{r, message=FALSE, results='hide', error=FALSE, echo=FALSE, warning=FALSE}

tda %>% gather(key="SESSO_ANNO", value="DECESSI", M_15:T_20)%>%
      separate(SESSO_ANNO, c("SESSO", "ANNO"), "_")%>%
      mutate(DATA=as.Date(paste0("0", GE, "2020"), format="%m%d%Y"))%>%
      mutate(DECESSI=as.numeric(DECESSI))->tda

tda<-left_join(tda, pop, by="COD_PROVCOM")

tda <- na.omit(tda)

tda %>% select(-c(NOME_PROVINCIA,REG, PROV, CL_ETA,GE))%>%
      filter(SESSO=="T", DECESSI<9999, format(as.Date(DATA), "%m")!="04" )%>%
      group_by(ANNO, NOME_REGIONE, NOME_COMUNE, COD_PROVCOM, TIPO_COMUNE, ABITANTI)%>%
      summarise(DECESSI=sum(DECESSI))->tdap

#abitanti per regione
tda%>% distinct(NOME_REGIONE, COD_PROVCOM, ABITANTI)%>%
  group_by(NOME_REGIONE)%>%
  summarise(abitanti=sum(ABITANTI))->AbitantiPerRegione

#abitanti per regione dei comuni considerati dall'Istat
tda%>% filter(TIPO_COMUNE!="3" )%>%
  distinct(NOME_COMUNE, NOME_REGIONE, ABITANTI)%>%
  group_by(NOME_REGIONE)%>%
  summarise(abitantiCampionati=sum(ABITANTI))->AbitantiPerRegioneCampionati

inner_join( AbitantiPerRegione, AbitantiPerRegioneCampionati, by="NOME_REGIONE")->TOT

#dataframe riassuntivo che compara le varie percentuali
TOT %>% mutate(percCAMPIONATI=abitantiCampionati/abitanti*100)->TOT

#ANALIZZO I MORTI della Lombardia
tdap %>% filter(NOME_REGIONE=="Lombardia")->tdapl
TOT %>%  filter(NOME_REGIONE=="Lombardia")->Lombardia

#morti per covid nei comuni campionati dall'Istat
tdapl %>% filter(TIPO_COMUNE!="3")%>%
  group_by(ANNO)%>%
  summarise(DECESSIperanno=sum(DECESSI))->tdaplc

#morti per covid nei comuni non campionati dall'Istat
tdaplc$DECESSIperanno[6]-tdaplc$DECESSIperanno[2]->mortiLombardiaCampionata

#percentuale di morti covid sulla popolazione campionata dall'Istat
mortalitàLombardiaCampionata<-as.vector(mortiLombardiaCampionata/Lombardia$abitantiCampionati)


#morti per covid nei comuni non campionati 
mortiLombardiaCampionata/Lombardia$abitantiCampionati*(Lombardia$abitanti-Lombardia$abitantiCampionati)->mortiLombardiaNonCampionatasup

mortiCOVIDinf<-mortiLombardiaCampionata
mortiCOVIDsup<-mortiLombardiaCampionata+mortiLombardiaNonCampionatasup
```
Forchetta per i morti covid con dati aggiornati in Lombardia fino a fine marzo
```{r}
print(c(mortiCOVIDinf, mortiCOVIDsup))
```
Questa stima, come ci aspettavamo, è più precisa.
Il risultato che avevamo trovato con i dati non aggiornati contiene questa forchetta di valori. Ciò conferma che la nostra stima iniziale anche se imprecisa, è sensata.